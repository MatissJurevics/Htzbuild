#cloud-config
# =============================================================================
# Cloud-init configuration for EAS Build Server
# Installs: Node.js 20, Java 17, Android SDK, EAS CLI
# =============================================================================

package_update: true
package_upgrade: false

packages:
  - unzip
  - git
  - curl
  - wget

runcmd:
  # Install Node.js 20.x
  - curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
  - apt-get install -y nodejs

  # Install Java 17
  - apt-get install -y openjdk-17-jdk-headless

  # Create Android SDK directory
  - mkdir -p /opt/android-sdk/cmdline-tools

  # Download and install Android command-line tools
  - curl -o /tmp/cmdline-tools.zip https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
  - unzip -q /tmp/cmdline-tools.zip -d /opt/android-sdk/cmdline-tools
  - mv /opt/android-sdk/cmdline-tools/cmdline-tools /opt/android-sdk/cmdline-tools/latest
  - rm /tmp/cmdline-tools.zip

  # Set permissions
  - chmod -R 755 /opt/android-sdk

  # Accept Android SDK licenses
  - yes | /opt/android-sdk/cmdline-tools/latest/bin/sdkmanager --licenses || true

  # Install required Android SDK components
  - /opt/android-sdk/cmdline-tools/latest/bin/sdkmanager --install "platform-tools"
  - /opt/android-sdk/cmdline-tools/latest/bin/sdkmanager --install "platforms;android-35"
  - /opt/android-sdk/cmdline-tools/latest/bin/sdkmanager --install "build-tools;35.0.0"
  - /opt/android-sdk/cmdline-tools/latest/bin/sdkmanager --install "ndk;27.0.12077973"

  # Install eas-cli globally
  - npm install -g eas-cli

  # Create project directory
  - mkdir -p /root/project

write_files:
  # Android SDK environment variables
  - path: /etc/profile.d/android.sh
    permissions: "0644"
    content: |
      export ANDROID_HOME=/opt/android-sdk
      export ANDROID_SDK_ROOT=/opt/android-sdk
      export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools

  # Bashrc additions for interactive shells
  - path: /root/.bashrc.d/android.sh
    permissions: "0644"
    content: |
      export ANDROID_HOME=/opt/android-sdk
      export ANDROID_SDK_ROOT=/opt/android-sdk
      export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools

final_message: "Cloud-init completed. System ready for EAS builds."

